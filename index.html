<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Purpose Manager">
    <title>Purpose Manager - Mobile Companion</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .header {
            background: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #4F46E5;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: #4F46E5;
            color: white;
        }
        
        .btn-secondary {
            background: #10B981;
            color: white;
        }
        
        .btn-icon {
            background: #4F46E5;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }
        
        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }
        
        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 12px;
        }
        
        .empty-state p {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .purpose-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .purpose-card:active {
            transform: scale(0.98);
        }
        
        .purpose-info h3 {
            font-size: 18px;
            color: #1F2937;
            margin-bottom: 4px;
        }
        
        .purpose-info p {
            font-size: 14px;
            color: #6B7280;
        }
        
        .purpose-icon {
            width: 50px;
            height: 50px;
            background: #EEF2FF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .receipt-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .receipt-thumbnail {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background: #F3F4F6;
            cursor: pointer;
        }
        
        .receipt-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .receipt-date {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 10px;
            padding: 4px;
            text-align: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: #1F2937;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6B7280;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #4F46E5;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: #4F46E5;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px;
        }
        
        .camera-input {
            display: none;
        }
        
        .floating-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #4F46E5;
            color: white;
            border: none;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            z-index: 100;
        }
        
        .floating-btn:active {
            transform: scale(0.95);
        }
        
        .export-btn {
            width: 100%;
            margin-top: 20px;
        }
        
        .receipt-detail-modal .modal-content {
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .receipt-image-large {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #4F46E5;
        }
        
        .delete-receipt-btn {
            background: #EF4444;
            color: white;
            width: 100%;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <!-- Main Screen -->
    <div id="mainScreen">
        <div class="header">
            <h1>üìã Purpose Manager</h1>
            <button class="btn-icon" onclick="showAddPurposeModal()">+</button>
        </div>
        
        <div class="container" id="purposeList">
            <div class="empty-state">
                <div class="empty-state-icon">üè∑Ô∏è</div>
                <h2>No Purposes Yet</h2>
                <p>Create purposes to organize your receipts</p>
                <button class="btn btn-primary" onclick="showAddPurposeModal()">
                    ‚ûï Create First Purpose
                </button>
            </div>
        </div>
        
        <button class="btn btn-secondary export-btn" id="exportBtn" onclick="exportPurposes()" style="display:none; margin: 20px;">
            üì§ Export All Purposes
        </button>
    </div>
    
    <!-- Purpose Detail Screen -->
    <div id="detailScreen" style="display:none;">
        <div class="header">
            <button class="back-btn" onclick="backToPurposes()">‚Üê</button>
            <h1 id="purposeTitle"></h1>
            <div style="display: flex; gap: 8px;">
                <button class="btn-icon" onclick="openCamera()" title="Take Photo">üì∑</button>
                <button class="btn-icon" onclick="openGallery()" title="Select Multiple">üñºÔ∏è</button>
            </div>
        </div>
        
        <div class="container">
            <!-- Processing notification -->
            <div id="processingNotification" style="display:none; position:fixed; top:80px; left:50%; transform:translateX(-50%); background:#4F46E5; color:white; padding:16px 24px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:1000; min-width:200px; text-align:center;">
                <div style="font-weight:600; margin-bottom:4px;" id="processingText">Processing...</div>
                <div style="font-size:14px;" id="processingProgress">0 of 0</div>
            </div>
            
            <div class="receipt-grid" id="receiptGrid"></div>
            
            <button class="btn btn-secondary export-btn" onclick="exportReceipts()">
                üì§ Export This Purpose
            </button>
        </div>
        
        <!-- Camera input for single photo -->
        <input type="file" class="camera-input" id="cameraInput" accept="image/*" capture="environment" onchange="handleImageCapture(event)">
        
        <!-- Gallery input for multiple photos -->
        <input type="file" class="camera-input" id="galleryInput" accept="image/*" multiple onchange="handleImageCapture(event)">
    </div>
    
    <!-- Add Purpose Modal -->
    <div class="modal" id="addPurposeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Purpose</h2>
                <button class="close-btn" onclick="closeModal('addPurposeModal')">‚úï</button>
            </div>
            <input type="text" id="purposeNameInput" placeholder="e.g., Client Dinners" />
            <button class="btn btn-primary" style="width:100%;" onclick="createPurpose()">Create Purpose</button>
        </div>
    </div>

    <!-- Receipt Detail Modal -->
    <div class="modal receipt-detail-modal" id="receiptDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Receipt Details</h2>
                <button class="close-btn" onclick="closeModal('receiptDetailModal')">‚úï</button>
            </div>
            
            <img id="receiptImageLarge" class="receipt-image-large" src="" alt="Receipt">
            
            <div class="form-group">
                <label for="receiptDate">Date</label>
                <input type="date" id="receiptDate" onchange="updateReceiptField('date', this.value)">
            </div>
            
            <div class="form-group">
                <label for="receiptAmount">Amount ($)</label>
                <input type="number" step="0.01" id="receiptAmount" placeholder="0.00" onchange="updateReceiptField('amount', this.value)">
            </div>
            
            <div class="form-group">
                <label for="receiptCategory">Category</label>
                <select id="receiptCategory" onchange="updateReceiptField('category', this.value)">
                    <option value="Airfare">Airfare</option>
                    <option value="Hotel">Hotel</option>
                    <option value="Car Rental">Car Rental</option>
                    <option value="Taxi">Taxi</option>
                    <option value="Fuel">Fuel</option>
                    <option value="Parking/Tolls">Parking/Tolls</option>
                    <option value="Breakfast">Breakfast</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Cable/Internet">Cable/Internet</option>
                    <option value="Phone">Phone</option>
                    <option value="Office Supplies">Office Supplies</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <button class="btn btn-primary" style="width:100%;" onclick="closeModal('receiptDetailModal')">Done</button>
            <button class="btn delete-receipt-btn" onclick="deleteCurrentReceipt()">Delete Receipt</button>
        </div>
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }

        // Data Storage
        let purposes = [];
        let currentPurposeId = null;
        let currentReceiptId = null;
        
        // Load data on startup
        loadData();
        
        function loadData() {
            const stored = localStorage.getItem('purposes');
            if (stored) {
                purposes = JSON.parse(stored);
            }
            renderPurposeList();
        }
        
        function saveData() {
            console.log('Saving purposes to localStorage:', purposes);
            localStorage.setItem('purposes', JSON.stringify(purposes));
            
            // Verify save worked
            const saved = localStorage.getItem('purposes');
            const parsed = JSON.parse(saved);
            console.log('Verified save - purposes in storage:', parsed);
        }
        
        function reloadData() {
            const stored = localStorage.getItem('purposes');
            if (stored) {
                purposes = JSON.parse(stored);
                console.log('Reloaded purposes from storage:', purposes);
            }
        }
        
        // OCR Processing
        // Purpose Management
        function showAddPurposeModal() {
            document.getElementById('addPurposeModal').classList.add('active');
            document.getElementById('purposeNameInput').value = '';
            document.getElementById('purposeNameInput').focus();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function createPurpose() {
            const name = document.getElementById('purposeNameInput').value.trim();
            if (!name) return;
            
            const purpose = {
                id: Date.now().toString(),
                name: name,
                receipts: []
            };
            
            purposes.push(purpose);
            saveData();
            renderPurposeList();
            closeModal('addPurposeModal');
        }
        
        function deletePurpose(purposeId) {
            const purpose = purposes.find(p => p.id === purposeId);
            
            if (!purpose) return;
            
            // Confirm deletion
            const receiptCount = purpose.receipts.length;
            const message = receiptCount > 0 
                ? `Delete "${purpose.name}" with ${receiptCount} receipt${receiptCount !== 1 ? 's' : ''}?\n\nThis cannot be undone.`
                : `Delete "${purpose.name}"?`;
            
            if (confirm(message)) {
                console.log(`Deleting purpose: ${purpose.name}`);
                purposes = purposes.filter(p => p.id !== purposeId);
                saveData();
                renderPurposeList();
                console.log(`Purpose deleted. Remaining: ${purposes.length}`);
            }
        }
        
        function renderPurposeList() {
            const container = document.getElementById('purposeList');
            const exportBtn = document.getElementById('exportBtn');
            
            if (purposes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üè∑Ô∏è</div>
                        <h2>No Purposes Yet</h2>
                        <p>Create purposes to organize your receipts</p>
                        <button class="btn btn-primary" onclick="showAddPurposeModal()">
                            ‚ûï Create First Purpose
                        </button>
                    </div>
                `;
                exportBtn.style.display = 'none';
            } else {
                container.innerHTML = purposes.map(purpose => `
                    <div class="purpose-card" style="position:relative;">
                        <div style="display:flex; gap:16px; align-items:center; flex:1;" onclick="openPurpose('${purpose.id}')">
                            <div class="purpose-icon">üè∑Ô∏è</div>
                            <div class="purpose-info">
                                <h3>${purpose.name}</h3>
                                <p>${purpose.receipts.length} receipt${purpose.receipts.length !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); deletePurpose('${purpose.id}')" style="background:none; border:none; font-size:20px; color:#EF4444; cursor:pointer; padding:8px; margin-left:8px;" title="Delete Purpose">
                            üóëÔ∏è
                        </button>
                    </div>
                `).join('');
                exportBtn.style.display = 'block';
            }
        }
        
        // Purpose Detail Screen
        function openPurpose(purposeId) {
            // Reload data to ensure we have latest from localStorage
            reloadData();
            
            currentPurposeId = purposeId;
            const purpose = purposes.find(p => p.id === purposeId);
            
            console.log(`Opening purpose: ${purpose.name}, receipts: ${purpose.receipts.length}`);
            
            document.getElementById('purposeTitle').textContent = purpose.name;
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('detailScreen').style.display = 'block';
            
            renderReceiptGrid();
        }
        
        function showMainScreen() {
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('detailScreen').style.display = 'none';
            currentPurposeId = null;
            renderPurposeList(); // Refresh the list
        }
        
        function backToPurposes() {
            showMainScreen();
        }
        
        function renderReceiptGrid() {
            const purpose = purposes.find(p => p.id === currentPurposeId);
            const grid = document.getElementById('receiptGrid');
            
            console.log('renderReceiptGrid called');
            console.log('Current purpose:', purpose);
            console.log('Receipts in purpose:', purpose.receipts.length);
            console.log('Receipt IDs:', purpose.receipts.map(r => r.id));
            
            if (purpose.receipts.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align:center; padding:60px 20px; color:white;">
                        <div style="font-size:60px; margin-bottom:16px;">üì∑</div>
                        <h3 style="margin-bottom:8px;">No Receipts Yet</h3>
                        <p style="margin-bottom:20px;">Choose how to add receipts:</p>
                        <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                            <button onclick="openCamera()" style="background:white; color:#667eea; padding:12px 24px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                                üì∑ Take Photo
                            </button>
                            <button onclick="openGallery()" style="background:white; color:#667eea; padding:12px 24px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                                üñºÔ∏è Select Multiple
                            </button>
                        </div>
                    </div>
                `;
            } else {
                const html = purpose.receipts.map(receipt => `
                    <div class="receipt-thumbnail" onclick="openReceiptDetail('${receipt.id}')">
                        <img src="${receipt.image}" alt="Receipt">
                        <div class="receipt-date">
                            ${receipt.date ? new Date(receipt.date).toLocaleDateString() : 'No date'}
                            <br>
                            ${receipt.amount ? '$' + receipt.amount : 'No amount'}
                        </div>
                    </div>
                `).join('');
                
                console.log('Generated HTML for', purpose.receipts.length, 'receipts');
                grid.innerHTML = html;
                console.log('Grid innerHTML set, children count:', grid.children.length);
            }
        }
        
        // Processing Notification Functions
        function showProcessingNotification(current, total) {
            const notification = document.getElementById('processingNotification');
            const text = document.getElementById('processingText');
            const progress = document.getElementById('processingProgress');
            
            text.textContent = 'üì∏ Processing receipts...';
            progress.textContent = `${current} of ${total}`;
            notification.style.display = 'block';
        }
        
        function updateProcessingNotification(current, total) {
            const progress = document.getElementById('processingProgress');
            progress.textContent = `${current} of ${total}`;
        }
        
        function hideProcessingNotification() {
            const notification = document.getElementById('processingNotification');
            notification.style.display = 'none';
        }
        
        // Camera Functions
        // Camera Functions
        function openCamera() {
            document.getElementById('cameraInput').click();
        }
        
        function openGallery() {
            document.getElementById('galleryInput').click();
        }
        
        async function handleImageCapture(event) {
            console.log('=== handleImageCapture START ===');
            const files = Array.from(event.target.files);
            console.log('Files selected:', files.length);
            if (files.length === 0) return;
            
            // Reset input immediately to prevent iOS from holding onto file references
            event.target.value = '';
            
            // Get purpose at start, not inside callback
            const purposeId = currentPurposeId;
            console.log('Current purpose ID:', purposeId);
            if (!purposeId) {
                console.error('No purpose selected');
                return;
            }
            
            const today = new Date();
            const todayFormatted = today.toISOString().split('T')[0]; // YYYY-MM-DD
            
            console.log(`Processing ${files.length} file(s)`);
            
            // Show processing notification
            showProcessingNotification(0, files.length);
            
            // Process files sequentially on mobile to avoid race conditions
            const receiptsToAdd = [];
            console.log('Starting file processing loop...');
            
            for (let index = 0; index < files.length; index++) {
                console.log(`--- Processing file ${index + 1} of ${files.length} ---`);
                const file = files[index];
                console.log('File name:', file.name, 'Size:', file.size);
                
                // Add small delay between files to help iOS Safari
                if (index > 0) {
                    console.log('Waiting 500ms before next file...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                try {
                    // Update notification
                    updateProcessingNotification(index + 1, files.length);
                    
                    // Use createObjectURL instead of FileReader for better iOS performance
                    console.log('Creating object URL from file...');
                    const imageUrl = URL.createObjectURL(file);
                    console.log('Object URL created:', imageUrl.substring(0, 50) + '...');
                    
                    // Convert to base64 for storage (required for localStorage)
                    console.log('Converting to base64...');
                    const imageData = await new Promise((resolve, reject) => {
                        const img = new Image();
                        let resolved = false;
                        
                        img.onload = () => {
                            if (resolved) return;
                            resolved = true;
                            
                            console.log('Image loaded, original dimensions:', img.width, 'x', img.height);
                            
                            // Resize image to max 1200px width for memory efficiency on mobile
                            const maxWidth = 1200;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                                console.log('Resizing to:', Math.round(width), 'x', Math.round(height));
                            } else {
                                console.log('No resize needed, image fits within', maxWidth, 'px');
                            }
                            
                            console.log('Creating canvas...');
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            
                            console.log('Drawing image to canvas...');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            console.log('Converting canvas to base64...');
                            const base64 = canvas.toDataURL('image/jpeg', 0.7);  // Reduced quality to 0.7
                            console.log('Canvas converted to base64, length:', base64.length);
                            
                            // Aggressive cleanup
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            canvas.width = 0;
                            canvas.height = 0;
                            img.src = '';
                            URL.revokeObjectURL(imageUrl);
                            
                            console.log('Cleanup complete');
                            resolve(base64);
                        };
                        
                        img.onerror = (e) => {
                            if (resolved) return;
                            resolved = true;
                            
                            console.error('Image load error:', e);
                            URL.revokeObjectURL(imageUrl);
                            reject(new Error('Failed to load image'));
                        };
                        
                        console.log('Setting image src...');
                        img.src = imageUrl;
                    });
                    
                    console.log('Image processing complete');
                    
                    const receipt = {
                        id: `receipt_${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${index}`,
                        image: imageData,
                        date: todayFormatted,
                        amount: '',
                        category: 'Other',
                        captureDate: today.toISOString()
                    };
                    
                    console.log('Created receipt with ID:', receipt.id);
                    receiptsToAdd.push(receipt);
                    console.log(`receiptsToAdd now has ${receiptsToAdd.length} items`);
                    
                } catch (error) {
                    console.error('Error processing file:', error);
                    alert(`Failed to process image ${index + 1}: ${error.message}`);
                }
            }
            
            console.log('=== File loop complete ===');
            console.log('Total receipts to add:', receiptsToAdd.length);
            console.log('Receipt IDs:', receiptsToAdd.map(r => r.id));
            
            // Now add all receipts at once
            if (receiptsToAdd.length > 0) {
                // Reload data to ensure we have latest
                console.log('Reloading data from localStorage...');
                reloadData();
                console.log('Purposes after reload:', purposes.length);
                
                const purpose = purposes.find(p => p.id === purposeId);
                console.log('Found purpose:', purpose ? purpose.name : 'NOT FOUND');
                
                if (purpose) {
                    console.log('Purpose receipts BEFORE adding:', purpose.receipts.length);
                    console.log('Adding', receiptsToAdd.length, 'new receipt(s)');
                    
                    purpose.receipts.push(...receiptsToAdd);
                    
                    console.log('Purpose receipts AFTER adding:', purpose.receipts.length);
                    console.log('All receipt IDs in purpose:', purpose.receipts.map(r => r.id));
                    
                    saveData();
                    console.log('Data saved to localStorage');
                    
                    // Verify save
                    const verification = JSON.parse(localStorage.getItem('purposes'));
                    const verifiedPurpose = verification.find(p => p.id === purposeId);
                    console.log('VERIFICATION - Receipts in localStorage:', verifiedPurpose.receipts.length);
                    
                    renderReceiptGrid();
                    console.log('Grid rendered');
                } else {
                    console.error('Purpose not found!');
                }
            }
            
            // Hide notification after a delay
            setTimeout(() => {
                hideProcessingNotification();
            }, 1000);
            
            console.log('=== handleImageCapture END ===');
        }
        
        // Receipt Detail Modal
        function openReceiptDetail(receiptId) {
            currentReceiptId = receiptId;
            const purpose = purposes.find(p => p.id === currentPurposeId);
            const receipt = purpose.receipts.find(r => r.id === receiptId);
            
            document.getElementById('receiptImageLarge').src = receipt.image;
            document.getElementById('receiptDate').value = receipt.date || '';
            document.getElementById('receiptAmount').value = receipt.amount || '';
            document.getElementById('receiptCategory').value = receipt.category || 'Other';
            
            document.getElementById('receiptDetailModal').classList.add('active');
        }
        
        function updateReceiptField(field, value) {
            console.log(`updateReceiptField called: ${field} = ${value}`);
            const purpose = purposes.find(p => p.id === currentPurposeId);
            const receipt = purpose.receipts.find(r => r.id === currentReceiptId);
            
            if (receipt) {
                console.log(`Before update - ${field}:`, receipt[field]);
                receipt[field] = value;
                console.log(`After update - ${field}:`, receipt[field]);
                console.log('Full receipt object:', receipt);
                saveData();
                renderReceiptGrid();
            } else {
                console.error('Receipt not found!');
            }
        }
        
        function deleteCurrentReceipt() {
            if (!confirm('Delete this receipt?')) return;
            
            const purpose = purposes.find(p => p.id === currentPurposeId);
            purpose.receipts = purpose.receipts.filter(r => r.id !== currentReceiptId);
            
            saveData();
            renderReceiptGrid();
            closeModal('receiptDetailModal');
        }
        
        // Export Functions
        async function exportPurposes() {
            console.log('=== exportPurposes START ===');
            console.log('Current purposes:', purposes);
            console.log('Number of purposes:', purposes.length);
            
            if (purposes.length === 0) {
                alert('No purposes to export. Create some purposes first!');
                return;
            }
            
            // Show processing notification
            showProcessingNotification(0, 1);
            updateProcessingNotification(1, 1);
            
            try {
                // Count total receipts
                const totalReceipts = purposes.reduce((sum, p) => sum + p.receipts.length, 0);
                console.log('Total receipts to export:', totalReceipts);
                
                // Create ZIP file
                const zip = new JSZip();
                
                // Create purposes metadata (with receipt references)
                const exportData = {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    source: "PWA Companion App",
                    totalPurposes: purposes.length,
                    totalReceipts: totalReceipts,
                    purposes: purposes.map(p => ({
                        name: p.name,
                        receiptCount: p.receipts.length,
                        receipts: p.receipts.map((r, idx) => {
                            console.log(`Receipt ${idx + 1} data:`, {date: r.date, amount: r.amount, category: r.category});
                            return {
                                filename: `${p.name.replace(/[^a-z0-9]/gi, '_')}_${idx + 1}.jpg`,
                                date: r.date || '',
                                amount: r.amount || '',
                                category: r.category || 'Other',
                                captureDate: r.captureDate
                            };
                        })
                    }))
                };
                
                console.log('Export metadata:', exportData);
                console.log('Full purposes data being exported:', JSON.stringify(exportData, null, 2));
                
                // Add purposes.json to ZIP
                zip.file('purposes.json', JSON.stringify(exportData, null, 2));
                
                // Add all receipt images to ZIP
                let receiptIndex = 0;
                for (const purpose of purposes) {
                    if (purpose.receipts.length > 0) {
                        // Create folder for this purpose
                        const folderName = purpose.name.replace(/[^a-z0-9]/gi, '_');
                        
                        for (let i = 0; i < purpose.receipts.length; i++) {
                            const receipt = purpose.receipts[i];
                            receiptIndex++;
                            
                            console.log(`Adding receipt ${receiptIndex}/${totalReceipts} to ZIP...`);
                            
                            // Convert base64 to blob
                            const base64Data = receipt.image.split(',')[1];
                            zip.file(`${folderName}/${folderName}_${i + 1}.jpg`, base64Data, {base64: true});
                        }
                    }
                }
                
                console.log('Generating ZIP file...');
                
                // Generate ZIP file
                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                console.log('ZIP generated, size:', zipBlob.size, 'bytes');
                
                const filename = `expense_report_${new Date().toISOString().split('T')[0]}.zip`;
                
                // Try to share via Web Share API
                if (navigator.share && navigator.canShare) {
                    try {
                        const file = new File([zipBlob], filename, { type: 'application/zip' });
                        
                        if (navigator.canShare({ files: [file] })) {
                            console.log('Using Web Share API...');
                            await navigator.share({
                                files: [file],
                                title: 'Expense Report Data',
                                text: `${purposes.length} purposes with ${totalReceipts} receipts`
                            });
                            console.log('Share completed successfully');
                            
                            hideProcessingNotification();
                            return;
                        }
                    } catch (err) {
                        console.log('Share error or cancelled:', err);
                    }
                }
                
                // Fallback: download
                console.log('Using download fallback...');
                downloadFile(zipBlob, filename);
                
                hideProcessingNotification();
                
            } catch (error) {
                console.error('Export error:', error);
                alert(`Export failed: ${error.message}`);
                hideProcessingNotification();
            }
            
            console.log('=== exportPurposes END ===');
        }
        
        async function exportReceipts() {
            const purpose = purposes.find(p => p.id === currentPurposeId);
            
            if (!purpose) {
                alert('Purpose not found');
                return;
            }
            
            if (purpose.receipts.length === 0) {
                alert('No receipts to export');
                return;
            }
            
            console.log(`=== Exporting purpose: ${purpose.name} ===`);
            console.log('Receipts:', purpose.receipts.length);
            
            // Show processing notification
            showProcessingNotification(0, 1);
            updateProcessingNotification(1, 1);
            
            try {
                // Create ZIP file
                const zip = new JSZip();
                
                // Create metadata for this purpose
                const exportData = {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    source: "PWA Companion App",
                    totalPurposes: 1,
                    totalReceipts: purpose.receipts.length,
                    purposes: [{
                        name: purpose.name,
                        receiptCount: purpose.receipts.length,
                        receipts: purpose.receipts.map((r, idx) => {
                            console.log(`Receipt ${idx + 1} data:`, {date: r.date, amount: r.amount, category: r.category});
                            return {
                                filename: `${purpose.name.replace(/[^a-z0-9]/gi, '_')}_${idx + 1}.jpg`,
                                date: r.date || '',
                                amount: r.amount || '',
                                category: r.category || 'Other',
                                captureDate: r.captureDate
                            };
                        })
                    }]
                };
                
                console.log('Export metadata:', exportData);
                
                // Add purposes.json to ZIP
                zip.file('purposes.json', JSON.stringify(exportData, null, 2));
                
                // Add all receipt images to ZIP
                const folderName = purpose.name.replace(/[^a-z0-9]/gi, '_');
                
                for (let i = 0; i < purpose.receipts.length; i++) {
                    const receipt = purpose.receipts[i];
                    console.log(`Adding receipt ${i + 1}/${purpose.receipts.length} to ZIP...`);
                    
                    // Convert base64 to blob
                    const base64Data = receipt.image.split(',')[1];
                    zip.file(`${folderName}/${folderName}_${i + 1}.jpg`, base64Data, {base64: true});
                }
                
                console.log('Generating ZIP file...');
                
                // Generate ZIP file
                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                console.log('ZIP generated, size:', zipBlob.size, 'bytes');
                
                const filename = `${purpose.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.zip`;
                
                // Try to share via Web Share API
                if (navigator.share && navigator.canShare) {
                    try {
                        const file = new File([zipBlob], filename, { type: 'application/zip' });
                        
                        if (navigator.canShare({ files: [file] })) {
                            console.log('Using Web Share API...');
                            await navigator.share({
                                files: [file],
                                title: `${purpose.name}`,
                                text: `${purpose.name} with ${purpose.receipts.length} receipt(s)`
                            });
                            console.log('Share completed successfully');
                            hideProcessingNotification();
                            return;
                        }
                    } catch (err) {
                        console.log('Share error or cancelled:', err);
                    }
                }
                
                // Fallback: download
                console.log('Using download fallback...');
                downloadFile(zipBlob, filename);
                
                hideProcessingNotification();
                
            } catch (error) {
                console.error('Export error:', error);
                alert(`Export failed: ${error.message}`);
                hideProcessingNotification();
            }
            
            console.log('=== Export complete ===');
        }
        
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });
        
        function showInstallPrompt() {
            // Optional: Show custom install button
            console.log('App can be installed');
        }
    </script>
</body>
</html>
